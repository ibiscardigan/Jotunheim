---
- name: Install apt-transport-https
  ansible.builtin.apt:
    name: apt-transport-https
    state: present
    update_cache: yes

- name: Add PostgreSQL APT signing key
  ansible.builtin.apt_key:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    state: present

- name: Add PostgreSQL repository
  ansible.builtin.apt_repository:
    repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main"
    state: present
    filename: "postgresql"

- name: Update apt cache after adding PostgreSQL repo
  ansible.builtin.apt:
    update_cache: yes

- name: Install required packages
  ansible.builtin.apt:
    name: "{{ postgresql_apt_list }}"
    state: present
    update_cache: yes

- name: Check if psycopg2 is importable by Python 3.13
  ansible.builtin.command: "{{ ansible_python_interpreter }} -c 'import psycopg2'"
  register: psycopg2_check
  failed_when: false
  changed_when: false

- name: Get Python 3.13 site-packages path (via sysconfig)
  ansible.builtin.command: >
    {{ ansible_python_interpreter }} -c "from sysconfig import get_paths; print(get_paths()['purelib'])"
  register: site_packages_path
  when: psycopg2_check.rc != 0

- name: Install psycopg2-binary into Python 3.13 site-packages
  ansible.builtin.shell: >
    {{ ansible_python_interpreter }} -m pip install psycopg2-binary --target={{ site_packages_path.stdout }}
  when: psycopg2_check.rc != 0
  args:
    executable: /bin/bash
